---
- hosts: k8s-09
  gather_facts: no
  vars:
    # For test reason the namespace can be provided via 'extra-vars' in command
    # 'nsible-playbook playbook.yaml  --extra-vars "namespace=ansible"'
    namespace: ansible

    gitlab_image: gitlab/gitlab-ce:8.13.6-ce.0
    jenkins_image: jenkins:2.19.3
    sonarqube_image: sonarqube:6.1
    nexus_image: sonatype/nexus:2.14.1-01

    gitlab_deploy_suffix_name: gitlab
    jenkins_deploy_suffix_name: jenkins
    sonarqube_deploy_suffix_name: sonarqube
    nexus_deploy_suffix_name: nexus

    deploy_yaml_file_path: /root/temp-bruce/deploy-on-k8s/yaml

  remote_user: root

  handlers:
    - name: create Jenkins service
      command: kubectl expose deployment "{{ namespace }}-{{ jenkins_deploy_suffix_name }}"
                 --type=NodePort  --namespace="{{ namespace }}"
      listen: "create services"

    - name: create Sonarqube service
      command: kubectl expose deployment "{{ namespace }}-{{ sonarqube_deploy_suffix_name }}"
                 --type=NodePort   --namespace="{{ namespace }}"
      listen: "create services"

    - name: create Nexus service
      command: kubectl expose deployment "{{ namespace }}-{{ nexus_deploy_suffix_name }}"
                 --type=NodePort   --namespace="{{ namespace }}"
      listen: "create services"

    - name: create Gitlab service
      command: kubectl expose deployment "{{ namespace }}-{{ gitlab_deploy_suffix_name }}"
                 --type=NodePort  --namespace="{{ namespace }}"
      listen: "create gitlab services"

# Ansible can not guarantee idempotency for applications on k8s cluster
# We have to do it by ourself. 
  pre_tasks:
    - name: copy template files after apply jinja2 filters to them.
      template:
        src: "{{ deploy_yaml_file_path }}/deploy-{{ item }}.yaml"
        dest: "/root/deploy-{{ item }}.yaml"
      with_items:
        - "{{ gitlab_deploy_suffix_name }}"
        - "{{ jenkins_deploy_suffix_name }}"
        - "{{ sonarqube_deploy_suffix_name }}"
        - "{{ nexus_deploy_suffix_name }}"
  roles:
# Create deplyments, pods and containers
  tasks:
    - name: check namespace "{{ namespace }}" exist or not
      command: kubectl get ns "{{ namespace }}"
      register: result
      ignore_errors: True

    - name: create namspace "{{ namespace }}" when it is not there
      command: kubectl create ns "{{ namespace }}"
      register: ns_created
      ignore_errors: True
      when: result|failed
# GitLab
    - name: check deployment "{{ namespace }}-{{ gitlab_deploy_suffix_name }}"  exist or not in namespace "{{ namespace }}"
      command: "kubectl get deploy {{ namespace }}-{{ gitlab_deploy_suffix_name }} --namespace={{ namespace }}"
      register: gitlab_exist
      ignore_errors: True
      when: ns_created|succeeded

    - name: If "{{ gitlab_deploy_suffix_name }}" does not exist in namespace "{{ namespace }}", deploy it  .
      command: kubectl create -f deploy-gitlab.yaml
      register: gitlab_created
      ignore_errors: True
      when: gitlab_exist|failed

    - name: "Report: Failed to create {{ gitlab_deploy_suffix_name }} in namespace {{ namespace }}"
      command: echo "failed to create {{ gitlab_deploy_suffix_name }}" in namespace "{{ namespace }}"
      when: gitlab_created|failed
# Jenkins
    - name: check deployment "{{ namespace }}-{{ jenkins_deploy_suffix_name }}"  exist or not in namespace "{{ namespace }}"
      command: "kubectl get deploy {{ namespace }}-{{ jenkins_deploy_suffix_name }} --namespace={{ namespace }}"
      register: jenkins_exist
      ignore_errors: True

    - name: If "{{ jenkins_deploy_suffix_name }}" does not exist in namespace "{{ namespace }}", deploy it  .
      command: kubectl create -f deploy-jenkins.yaml
      register: jenkins_created
      ignore_errors: True
      when: jenkins_exist|failed

    - name: "Report: Failed to create {{ jenkins_deploy_suffix_name }} in namespace {{ namespace }}"
      command:  echo "failed to create {{ jenkins_deploy_suffix_name }}" in namespace "{{ namespace }}"
      when: jenkins_created|failed

# SonarQube
    - name: check deployment "{{ namespace }}-{{ sonarqube_deploy_suffix_name }}"  exist or not in namespace "{{ namespace }}"
      command: "kubectl get deploy {{ namespace }}-{{ sonarqube_deploy_suffix_name }} --namespace={{ namespace }}"
      register: sonarqube_exist
      ignore_errors: True

    - name: If "{{ sonarqube_deploy_suffix_name }}" does not exist in namespace "{{ namespace }}", deploy it  .
      command: kubectl create -f deploy-sonarqube.yaml
      register: sonarqube_created
      ignore_errors: True
      when: sonarqube_exist|failed

    - name: "Report: Failed to create {{ sonarqube_deploy_suffix_name }} in namespace {{ namespace }}"
      command:  echo "failed to create {{ sonarqube_deploy_suffix_name }}" in namespace "{{ namespace }}"
      when: sonarqube_created|failed

# Nexus
    - name: check deployment "{{ namespace }}-{{ nexus_deploy_suffix_name }}"  exist or not in namespace "{{ namespace }}"
      command: "kubectl get deploy {{ namespace }}-{{ nexus_deploy_suffix_name }} --namespace={{ namespace }}"
      register: nexus_exist
      ignore_errors: True

    - name: If "{{ nexus_deploy_suffix_name }}" does not exist in namespace "{{ namespace }}", deploy it  .
      command: kubectl create -f deploy-nexus.yaml
      register: nexus_created
      ignore_errors: True
      when: nexus_exist|failed

    - name: "Report: Failed to create {{ nexus_deploy_suffix_name }} in namespace {{ namespace }}"
      command:  echo "failed to create {{ nexus_deploy_suffix_name }}" in namespace "{{ namespace }}"
      when: nexus_created|failed
# Service
    - name: start to create services
      command: echo ""
      notify: "create services"
# Validation of the deployments, pods and containers
  post_tasks:
